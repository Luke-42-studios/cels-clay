---
phase: 04-ncurses-clay-renderer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/cels-clay/include/cels-clay/clay_ncurses_renderer.h
  - modules/cels-clay/src/clay_ncurses_renderer.c
  - modules/cels-clay/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Clay rectangle commands produce filled cells with correct background color via tui_draw_fill_rect"
    - "Clay text commands render at correct position, with non-null-terminated StringSlice safely copied to stack buffer"
    - "Clay border commands render using theme box-drawing characters via tui_draw_border with per-side mask"
    - "Scissor start/end commands map to tui_push_scissor/tui_pop_scissor correctly"
    - "RGBA colors from Clay map to ncurses 256-color via tui_color_rgb"
    - "Float bounding boxes convert to integer cell rects with aspect ratio compensation on horizontal values"
    - "Text measurement callback returns wcwidth-accurate dimensions for Clay layout"
  artifacts:
    - path: "modules/cels-clay/include/cels-clay/clay_ncurses_renderer.h"
      provides: "ClayNcursesTheme struct, default theme, init function declaration"
      contains: "ClayNcursesTheme"
    - path: "modules/cels-clay/src/clay_ncurses_renderer.c"
      provides: "Provider callback, render loop, coordinate mapping, text measurement"
      contains: "_CEL_Provides"
    - path: "modules/cels-clay/CMakeLists.txt"
      provides: "Conditional compilation of renderer source when cels-ncurses available"
      contains: "clay_ncurses_renderer"
  key_links:
    - from: "clay_ncurses_renderer.c"
      to: "ClayRenderableData singleton"
      via: "_CEL_Provides(NCurses, ClayRenderable, ClayRenderableData, callback)"
      pattern: "_CEL_Provides.*ClayRenderable"
    - from: "clay_ncurses_renderer.c"
      to: "cels-ncurses drawing API"
      via: "tui_draw_fill_rect, tui_draw_text, tui_draw_border, tui_push_scissor"
      pattern: "tui_draw_"
    - from: "clay_ncurses_renderer.c"
      to: "Clay text measurement"
      via: "Clay_SetMeasureTextFunction"
      pattern: "Clay_SetMeasureTextFunction"
---

<objective>
Implement the complete ncurses Clay renderer that translates Clay_RenderCommandArray into visible terminal output using cels-ncurses drawing primitives.

Purpose: This is the core rendering layer that makes Clay layouts visible in the terminal. Without it, Clay computes layout but nothing appears on screen. The renderer bridges Clay's float-based render commands to ncurses integer cell-based drawing.

Output: Public header with theme struct, renderer source with provider callback handling all 5 command types (rectangle, text, border, scissor start, scissor end), wcwidth-based text measurement callback, and CMake wiring.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/API-DESIGN.md
@.planning/phases/04-ncurses-clay-renderer/04-CONTEXT.md
@.planning/phases/04-ncurses-clay-renderer/04-RESEARCH.md

Key source files to read before implementing:
- modules/cels-clay/include/cels-clay/clay_render.h (ClayRenderableData, ClayRenderable feature)
- modules/cels-clay/src/clay_render.c (_CEL_DefineFeature pattern)
- modules/cels-clay/include/cels-clay/clay_engine.h (module API pattern)
- modules/cels-clay/CMakeLists.txt (INTERFACE library, current sources)
- modules/cels-ncurses/include/cels-ncurses/tui_draw.h (tui_draw_fill_rect, tui_draw_text, tui_draw_border, TUI_BorderChars, TUI_SIDE_*)
- modules/cels-ncurses/include/cels-ncurses/tui_color.h (tui_color_rgb, TUI_Style, TUI_COLOR_DEFAULT, TUI_ATTR_*)
- modules/cels-ncurses/include/cels-ncurses/tui_types.h (TUI_CellRect, tui_rect_to_cells, tui_cell_rect_intersect)
- modules/cels-ncurses/include/cels-ncurses/tui_scissor.h (tui_scissor_reset, tui_push_scissor, tui_pop_scissor)
- modules/cels-ncurses/include/cels-ncurses/tui_frame.h (tui_frame_get_background, TUI_Layer)
- modules/cels-ncurses/include/cels-ncurses/tui_layer.h (tui_layer_get_draw_context)
- modules/cels-ncurses/src/graphics/tui_draw.c (tui_border_chars_get pattern, TUI_BorderChars usage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Public header with theme struct and renderer API</name>
  <files>modules/cels-clay/include/cels-clay/clay_ncurses_renderer.h</files>
  <action>
Create the public header for the ncurses Clay renderer.

Contents:

1. **ClayNcursesTheme struct** with these fields (all const char* for UTF-8 strings):
   - `border` sub-struct: `hline`, `vline`, `ul`, `ur`, `ll`, `lr` (6 box-drawing characters)
   - `scrollbar` sub-struct: `track`, `thumb` (Unicode block characters)
   - `float cell_aspect_ratio` (default 2.0 -- cells are ~2x taller than wide)
   - `bool alpha_as_dim` (true = alpha < 128 uses A_DIM attribute)

2. **CLAY_NCURSES_THEME_DEFAULT** as a static const with:
   - Single-line Unicode box-drawing: hline=U+2500, vline=U+2502, ul=U+250C, ur=U+2510, ll=U+2514, lr=U+2518
   - Use raw UTF-8 byte sequences (e.g., "\xe2\x94\x80" for U+2500) since C99 may not support \u escapes in all compilers
   - Scrollbar: track=U+2502 (same as vline), thumb=U+2588 (full block)
   - cell_aspect_ratio=2.0f, alpha_as_dim=true

3. **Function declarations:**
   - `void clay_ncurses_renderer_init(const ClayNcursesTheme* theme)` -- call with NULL for default theme
   - `void clay_ncurses_renderer_set_theme(const ClayNcursesTheme* theme)` -- change theme at runtime

Include guards: CELS_CLAY_NCURSES_RENDERER_H
Required includes: stdbool.h (for bool in theme struct)

Do NOT include any ncurses headers in the public header. The theme struct is pure C data. The renderer source includes ncurses internally.
Do NOT include cels-ncurses headers in the public header. The sibling module constraint means consumers include both modules independently.
  </action>
  <verify>
File exists and contains ClayNcursesTheme struct, CLAY_NCURSES_THEME_DEFAULT definition, and function declarations. No ncurses or cels-ncurses includes in the header.
  </verify>
  <done>
Public header defines the complete theme struct with border characters, scrollbar characters, aspect ratio, and alpha handling. Default theme has single-line Unicode borders. Init function declared.
  </done>
</task>

<task type="auto">
  <name>Task 2: Renderer implementation and CMake wiring</name>
  <files>
    modules/cels-clay/src/clay_ncurses_renderer.c
    modules/cels-clay/CMakeLists.txt
  </files>
  <action>
Create the renderer source file and update CMake to conditionally compile it.

**clay_ncurses_renderer.c** -- implement these sections:

1. **Includes:** cels-clay/clay_ncurses_renderer.h, cels-clay/clay_render.h, clay.h, cels/cels.h, then cels-ncurses headers (tui_draw.h, tui_color.h, tui_types.h, tui_scissor.h, tui_frame.h, tui_layer.h), then stdlib.h, string.h, math.h, wchar.h.

2. **Static state:**
   - `static const ClayNcursesTheme* g_theme = &CLAY_NCURSES_THEME_DEFAULT;`
   - `static TUI_BorderChars g_theme_border_chars;` (converted cchar_t values from theme UTF-8 strings)
   - `static bool g_border_chars_initialized = false;`

3. **init_theme_border_chars()** -- convert theme UTF-8 strings to cchar_t values:
   - For each of the 6 border characters (hline, vline, ul, ur, ll, lr):
     - Use mbstowcs to convert UTF-8 to wchar_t
     - Use setcchar to create cchar_t
     - Store in static cchar_t variables, point g_theme_border_chars members at them
   - Call this from renderer init and from set_theme

4. **clay_bbox_to_cells(Clay_BoundingBox bbox)** -- coordinate mapping:
   - Scale horizontal values (x, width) by g_theme->cell_aspect_ratio
   - Use roundf for position AND dimensions (CONTEXT.md says "round to nearest cell")
   - Enforce minimum 1 cell: if bbox.width > 0 && computed_w < 1, set w = 1 (same for height)
   - Return TUI_CellRect

   IMPORTANT: Do NOT apply aspect ratio scaling to text bounding boxes. The text measurement callback already returns cell-column-accurate widths. Aspect ratio only affects non-text geometry. However, since the renderer gets generic bounding boxes per command and doesn't know at the bbox conversion level whether it's text... the simplest approach is: apply aspect ratio to ALL bounding boxes uniformly, and have the text measurement callback report widths DIVIDED by aspect ratio. This way Clay computes layout in "aspect-adjusted" units and the renderer scales everything back to cells uniformly. Document this clearly in comments.

   Actually, the RESEARCH.md open question #1 recommends: "text bounding boxes should NOT be aspect-ratio-scaled. Only non-text bounding boxes need scaling." The cleanest approach: have TWO conversion functions:
   - `clay_bbox_to_cells(bbox)` -- applies aspect ratio to x and width
   - `clay_text_bbox_to_cells(bbox)` -- does NOT apply aspect ratio (text is already in cell columns)

   The text measurement callback returns dimensions in CELL COLUMNS (wcwidth units). These are already correct for the terminal. So text bounding boxes from Clay are already in cell-accurate units. The renderer should NOT scale text boxes horizontally.

5. **render_rectangle(ctx, cell_rect, data):**
   - Extract backgroundColor from Clay_RectangleRenderData
   - Create TUI_Style with bg = tui_color_rgb(r, g, b), fg = TUI_COLOR_DEFAULT
   - If g_theme->alpha_as_dim && color.a < 128, set attrs |= TUI_ATTR_DIM
   - Call tui_draw_fill_rect(ctx, cell_rect, ' ', style)

6. **render_text(ctx, cell_rect, data):**
   - Extract stringContents (Clay_StringSlice) and textColor from Clay_TextRenderData
   - Guard: if length <= 0 or chars == NULL, return
   - Null-terminate: use char buf_stack[512] on stack, malloc fallback if text.length >= 512
   - memcpy + null terminate
   - Create TUI_Style with fg = tui_color_rgb(r, g, b), bg = TUI_COLOR_DEFAULT
   - Call tui_draw_text(ctx, cell_rect.x, cell_rect.y, buf, style)
   - Free malloc buffer if used

7. **render_border(ctx, cell_rect, data):**
   - Build per-side mask from Clay_BorderRenderData.width (top/right/bottom/left > 0 = side enabled)
   - If no sides enabled, return
   - Use theme border chars (g_theme_border_chars) NOT Clay's border color
   - Since tui_draw_border takes TUI_BorderStyle enum but we need custom chars, render borders manually:
     - Apply style (TUI_Style with fg from theme consideration -- use TUI_COLOR_DEFAULT for v1 since theme doesn't specify color)
     - Use mvwadd_wch with g_theme_border_chars for corners and edges, following the same per-cell clipping pattern as tui_draw.c's tui_draw_border
     - Actually, simpler: call tui_draw_border(ctx, cell_rect, sides, TUI_BORDER_SINGLE, style) for v1. The theme's default chars match TUI_BORDER_SINGLE. Custom chars from theme are a refinement that can use the manual path later. For v1, map theme to TUI_BORDER_SINGLE.
   - REVISED approach: For v1, just use tui_draw_border with TUI_BORDER_SINGLE. The default theme uses single-line chars which match exactly. This avoids duplicating the border rendering loop. Document that custom theme chars beyond single/double/rounded would need a custom draw path in v2.

8. **clay_ncurses_render(ecs_iter_t* it)** -- the provider callback:
   - Get ClayRenderableData from ecs_field
   - If !dirty, return
   - Get background layer: tui_frame_get_background()
   - Get draw context: tui_layer_get_draw_context(layer)
   - Reset scissor: tui_scissor_reset(&ctx)
   - Iterate Clay_RenderCommandArray:
     - Get each command via Clay_RenderCommandArray_Get(&cmds, j)
     - Convert bounding box to cells (use clay_bbox_to_cells for most, clay_text_bbox_to_cells for TEXT)
     - Switch on commandType:
       - CLAY_RENDER_COMMAND_TYPE_RECTANGLE -> render_rectangle
       - CLAY_RENDER_COMMAND_TYPE_TEXT -> render_text (use text bbox converter)
       - CLAY_RENDER_COMMAND_TYPE_BORDER -> render_border
       - CLAY_RENDER_COMMAND_TYPE_SCISSOR_START -> tui_push_scissor(&ctx, cell_rect)
       - CLAY_RENDER_COMMAND_TYPE_SCISSOR_END -> tui_pop_scissor(&ctx)
       - default: break (skip IMAGE, CUSTOM, NONE)

9. **clay_ncurses_measure_text(Clay_StringSlice, Clay_TextElementConfig*, void*):**
   - Text measurement callback for Clay_SetMeasureTextFunction
   - Null-terminate the StringSlice (same stack buffer pattern as render_text)
   - Convert to wchar_t via mbstowcs (stack wchar_t[256] with malloc fallback)
   - Walk wide chars: accumulate column width via wcwidth(), track newlines for height
   - Return Clay_Dimensions with width = max_line_width, height = number_of_lines
   - On mbstowcs failure, fallback: width = text.length, height = 1
   - Do NOT apply aspect ratio here -- text widths are in cell columns, which is the correct unit

10. **clay_ncurses_renderer_init(const ClayNcursesTheme* theme):**
    - Store theme pointer (or default if NULL)
    - Initialize theme border chars via init_theme_border_chars()
    - Register text measurement callback: Clay_SetMeasureTextFunction(clay_ncurses_measure_text, NULL)
    - Register as provider: _CEL_Provides(NCurses, ClayRenderable, ClayRenderableData, clay_ncurses_render)

11. **clay_ncurses_renderer_set_theme(const ClayNcursesTheme* theme):**
    - Store new theme pointer (or default if NULL)
    - Re-initialize border chars

**CMakeLists.txt update:**
- Add clay_ncurses_renderer.c to target_sources but ONLY when cels-ncurses target exists
- Use: `if(TARGET cels-ncurses)` guard around:
  - `target_sources(cels-clay INTERFACE ${CMAKE_CURRENT_SOURCE_DIR}/src/clay_ncurses_renderer.c)`
  - `target_link_libraries(cels-clay INTERFACE cels-ncurses)`
- This makes the renderer conditional on cels-ncurses being available as a CMake target
- The INTERFACE link propagates ncurses include paths and link flags to consumers

IMPORTANT anti-patterns from RESEARCH.md:
- Do NOT create a separate WINDOW -- use tui_frame_get_background() layer
- Do NOT call wrefresh/wnoutrefresh/doupdate -- frame pipeline handles compositing
- Do NOT manually track color pair numbers -- use tui_color_rgb + tui_style_apply
- Do NOT re-implement scissor -- use tui_push_scissor/tui_pop_scissor
  </action>
  <verify>
1. `cmake -B build -S /home/cachy/workspaces/libs/cels -DCELS_BUILD_TOOLS=ON -DCELS_DEBUG=ON 2>&1` completes without errors (CMake configure)
2. Source file contains _CEL_Provides registration, all 5 command type handlers, text measurement callback
3. CMakeLists.txt has `if(TARGET cels-ncurses)` guard around renderer source and link
4. No direct ncurses calls (wrefresh, wnoutrefresh, doupdate, init_pair) in the renderer -- only cels-ncurses API calls
  </verify>
  <done>
Complete renderer implementation: provider callback handles all 5 Clay render command types (rectangle, text, border, scissor start/end), text measurement callback uses wcwidth for accurate column widths, coordinate mapping applies aspect ratio to non-text bounding boxes, CMake conditionally compiles renderer when cels-ncurses is available. Requirements covered: REND-01 (rectangles), REND-02 (text), REND-03 (borders), REND-04 (scissor), REND-05 (coordinate mapping), REND-06 (color mapping), REND-07 (wide char measurement).
  </done>
</task>

</tasks>

<verification>
1. CMake configures successfully with both cels-clay and cels-ncurses modules
2. The renderer source includes _CEL_Provides macro call registering for ClayRenderable feature
3. All 5 Clay render command types have handler functions in the switch statement
4. Clay_SetMeasureTextFunction is called in renderer init
5. StringSlice null-termination pattern is present in both render_text and measure_text
6. Aspect ratio scaling is applied in clay_bbox_to_cells but NOT in clay_text_bbox_to_cells
7. Theme struct has sensible defaults (single-line Unicode borders, 2.0 aspect ratio)
8. No anti-pattern violations: no wrefresh calls, no manual color pairs, no separate WINDOW creation
</verification>

<success_criteria>
- clay_ncurses_renderer.h defines ClayNcursesTheme with border/scrollbar chars, aspect ratio, alpha handling
- clay_ncurses_renderer.c implements the full render loop as a ClayRenderable provider (~200-300 lines)
- Text measurement callback returns wcwidth-accurate dimensions
- Coordinate mapping handles aspect ratio (2.0 default) for non-text elements
- CMake conditionally includes renderer when cels-ncurses target exists
- Requirements REND-01 through REND-07 are addressed
</success_criteria>

<output>
After completion, create `.planning/phases/04-ncurses-clay-renderer/04-01-SUMMARY.md`
</output>
