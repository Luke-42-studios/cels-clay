---
phase: 05-demo-app-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/cels-clay/examples/demo/main.c
  - modules/cels-clay/examples/demo/components.h
  - modules/cels-clay/examples/demo/theme.h
  - modules/cels-clay/examples/demo/pages.h
  - CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "A sidebar and content area are visible in the terminal, laid out by Clay with correct proportions"
    - "Static and dynamic text content renders correctly, with dynamic text updating when CELS state changes"
    - "A button element shows visual feedback (highlight) when selected via keyboard navigation"
    - "The full pipeline works: CELS compositions define structure, Clay computes layout, ncurses renders output, and state changes trigger visible UI updates"
  artifacts:
    - path: "modules/cels-clay/examples/demo/main.c"
      provides: "CEL_Build entry point, AppUI root, input system, state init"
      min_lines: 100
    - path: "modules/cels-clay/examples/demo/components.h"
      provides: "App-level component definitions (NavState, DemoSettings)"
      min_lines: 20
    - path: "modules/cels-clay/examples/demo/theme.h"
      provides: "Theme A and Theme B color definitions"
      min_lines: 20
    - path: "modules/cels-clay/examples/demo/pages.h"
      provides: "Layout functions and compositions for Home, Settings, About pages"
      min_lines: 100
    - path: "CMakeLists.txt"
      provides: "cels_clay_demo build target"
      contains: "cels_clay_demo"
  key_links:
    - from: "modules/cels-clay/examples/demo/main.c"
      to: "Clay_Engine_use"
      via: "Module init in CEL_Build"
      pattern: "Clay_Engine_use"
    - from: "modules/cels-clay/examples/demo/main.c"
      to: "clay_ncurses_renderer_init"
      via: "Renderer registration in CEL_Build"
      pattern: "clay_ncurses_renderer_init"
    - from: "modules/cels-clay/examples/demo/main.c"
      to: "ClaySurface"
      via: "Root layout boundary in AppUI"
      pattern: "ClaySurface"
    - from: "modules/cels-clay/examples/demo/pages.h"
      to: "CEL_Clay_Children"
      via: "Child emission in layout functions"
      pattern: "CEL_Clay_Children"
    - from: "modules/cels-clay/examples/demo/main.c"
      to: "CEL_Update"
      via: "State mutation in input system"
      pattern: "CEL_Update"
---

<objective>
Create the complete cels-clay demo application: a three-page terminal app (Home, Settings, About) with sidebar navigation, keyboard interaction, theme toggling, and scroll containers.

Purpose: This is the first consumer of the cels-clay module, proving CELS state + Clay layout + ncurses rendering work end-to-end. It also serves as the canonical example for how to build a cels-clay application.

Output: Four source files in `examples/demo/` and a CMake build target `cels_clay_demo`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/API-DESIGN.md
@.planning/phases/05-demo-app-integration/05-CONTEXT.md
@.planning/phases/05-demo-app-integration/05-RESEARCH.md

# Key source files for reference patterns
@modules/cels-clay/include/cels-clay/clay_engine.h
@modules/cels-clay/include/cels-clay/clay_layout.h
@modules/cels-clay/include/cels-clay/clay_ncurses_renderer.h
@modules/cels-clay/include/cels-clay/clay_render.h
@examples/app.c
@examples/components.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create demo app source files (components.h, theme.h, pages.h, main.c)</name>
  <files>
    modules/cels-clay/examples/demo/components.h
    modules/cels-clay/examples/demo/theme.h
    modules/cels-clay/examples/demo/pages.h
    modules/cels-clay/examples/demo/main.c
  </files>
  <action>
Create four files following the architecture from 05-RESEARCH.md. Reference `examples/app.c` for the canonical CELS pattern, but use Clay layout functions instead of the old render provider approach.

**components.h** -- App-level component and state definitions:
- `CEL_State(NavState, { int current_page; int sidebar_selected; int focus_pane; })` -- 0=Home, 1=Settings, 2=About; focus_pane 0=sidebar, 1=content
- `CEL_State(DemoSettings, { bool show_borders; int color_mode; })` -- show_borders toggles content borders; color_mode 0=Theme A, 1=Theme B
- Include guard, include `<cels/cels.h>`

**theme.h** -- Two color themes as Clay_Color struct arrays:
- Define a `DemoTheme` struct holding colors for: sidebar_bg, content_bg, title_bar_bg, status_bar_bg, selected_bg, focused_border, text_primary, text_secondary, text_accent
- Theme A: dark scheme with subtle blue tints (sidebar slightly darker than content)
- Theme B: warmer scheme with amber/brown tints
- `demo_get_theme(int color_mode)` inline function returning pointer to Theme A (0) or Theme B (1)
- All colors as `Clay_Color` structs `{r, g, b, a}` with alpha 255

**pages.h** -- Layout functions and compositions for all three pages plus shell:

Layout functions (CEL_Clay_Layout):
- `app_shell_layout`: CLAY_TOP_TO_BOTTOM, GROW/GROW sizing, contains title bar + main body + status bar; CEL_Clay_Children() emits the main body content between title and status bars
- `title_bar_layout`: GROW width, FIXED(3) height, centered text "cels-clay demo", border CLAY_BORDER_OUTSIDE(1), reads DemoSettings for theme colors
- `status_bar_layout`: GROW width, FIXED(1) height, text showing key hints "j/k: navigate  h/l: switch pane  Enter: select  q: quit", border CLAY_BORDER_OUTSIDE(1)
- `main_body_layout`: LEFT_TO_RIGHT, GROW/GROW, CEL_Clay_Children() to emit sidebar + content
- `sidebar_layout`: PERCENT(0.25f) width with no max cap needed (Clay handles it), TOP_TO_BOTTOM, 1-cell padding, border on right side, background from theme. Reads NavState to highlight selected item. Emits children (NavItems)
- `nav_item_layout`: Reads NavState for highlight. If this item's index == sidebar_selected, use selected_bg color. If focus_pane == 0 (sidebar focused), make the selected item brighter. Display text label.
- `content_area_layout`: GROW width, TOP_TO_BOTTOM, 1-cell padding, background from theme. Optional border based on DemoSettings.show_borders. CEL_Clay_Children() for page content. Content title showing current page name at top.
- `content_router_layout`: pass-through, just CEL_Clay_Children()
- `home_page_layout`: TOP_TO_BOTTOM with childGap=1. Feature showcase: 2-3 nested containers demonstrating Clay's layout (e.g., a row of two boxes, a centered text element, a bordered section). Use static CLAY_STRING for text. Show what cels-clay can do -- nested containers, mixed sizing modes, text.
- `settings_page_layout`: TOP_TO_BOTTOM. Two toggle items displaying "Show borders: ON/OFF" and "Color mode: Theme A/Theme B" using CEL_Clay_Text for dynamic strings. Highlight the selected toggle if sidebar_selected maps to it. Uses NavState for selection within settings (reuse sidebar_selected when focus_pane==1, with item_count=2).
- `about_page_layout`: Scroll container with `.clip = { .vertical = true, .childOffset = Clay_GetScrollOffset() }`. Multiple paragraphs of text about cels-clay (what it is, architecture, how it works). Enough text to require scrolling (8+ lines in a typical terminal).

Compositions (CEL_Composition):
- `AppShell` -- CEL_Has(ClayUI, .layout_fn = app_shell_layout), children: TitleBar + MainBody + StatusBar
- `TitleBar` -- CEL_Has(ClayUI, .layout_fn = title_bar_layout)
- `StatusBar` -- CEL_Has(ClayUI, .layout_fn = status_bar_layout)
- `MainBody` -- CEL_Has(ClayUI, .layout_fn = main_body_layout), children: Sidebar + ContentArea
- `Sidebar` -- CEL_Has(ClayUI, .layout_fn = sidebar_layout), children: 3x NavItem
- `NavItem` with props `const char* label; int index;` -- CEL_Has(ClayUI, .layout_fn = nav_item_layout)
- Store NavItem label/index in a simple component so layout function can read them
- `ContentArea` -- CEL_Has(ClayUI, .layout_fn = content_area_layout), child: ContentRouter
- `ContentRouter` -- CEL_Watch(NavState), switch on current_page to mount HomePage/SettingsPage/AboutPage
- `HomePage`, `SettingsPage`, `AboutPage` -- each with their layout function

Shorthand macros: `#define AppShell(...) CEL_Init(AppShell, __VA_ARGS__)` etc.

Include `<cels-clay/clay_layout.h>`, `<clay.h>`, `"components.h"`, `"theme.h"`

IMPORTANT patterns from research:
- Use `CEL_Clay(...)` (NOT bare `CLAY()`) for auto-ID generation
- Use `CEL_Clay_Children()` in every layout function that has child compositions
- Use `CLAY_STRING("literal")` for static strings, `CEL_Clay_Text(buf, len)` only for dynamic strings
- For NavItem label access in layout function: define a simple `CEL_Define(NavItemData, { const char* label; int index; })` component in components.h
- Settings toggle state: reuse sidebar_selected (0 or 1) when focus_pane == 1 to select which toggle. Enter toggles the selected setting.

**main.c** -- Application entry point:

Includes: `<cels/cels.h>`, `<cels-ncurses/tui_engine.h>`, `<cels-clay/clay_engine.h>`, `<cels-clay/clay_layout.h>`, `<cels-clay/clay_ncurses_renderer.h>`, `<clay.h>`, `"components.h"`, `"pages.h"`, `"theme.h"`, `<string.h>`

Input system `DemoInputSystem` at CELS_Phase_OnUpdate:
- Previous input tracking via static `g_prev_input` (same pattern as app.c)
- `input->has_raw_key` for j/k/h/l (NOT axis_left -- see research pitfall 2)
- j: if focus_pane==0, increment sidebar_selected (wrap at 3); if focus_pane==1 && current_page==1 (settings), increment settings selection (wrap at 2)
- k: same but decrement
- h: set focus_pane = 0
- l: set focus_pane = 1
- q: call `cels_request_quit()` (or set quit flag -- check what the existing app does for quit)
- `input->button_accept` (Enter): if focus_pane==0, set current_page = sidebar_selected AND reset sidebar_selected for content. If focus_pane==1 && current_page==1, toggle the selected setting (show_borders or color_mode)
- Scroll: only when focus_pane==1 && current_page==2 (About), call `clay_ncurses_handle_scroll_input(input, g_frame_state.delta_time)`
- Copy input at end: `memcpy(&g_prev_input, input, sizeof(CELS_Input))`

AppUI root composition (CEL_Root with TUI_EngineContext):
- Watch window state via `CEL_WatchId(ctx.windowState, TUI_WindowState_t)`
- When WINDOW_STATE_READY: mount ClaySurface with `width = (float)win->width / 2.0f`, `height = (float)win->height`
- Inside ClaySurface: `AppShell() {}`

CEL_Build(DemoApp):
- `TUI_Engine_use((TUI_EngineConfig){ .title = "cels-clay demo", .version = "0.2.0", .fps = 60, .root = AppUI })`
- `Clay_Engine_use(NULL)` -- all defaults
- `clay_ncurses_renderer_init(NULL)` -- default theme
- Init NavState: current_page=0, sidebar_selected=0, focus_pane=0
- Init DemoSettings: show_borders=true, color_mode=0

For quit handling: check how `examples/app.c` handles quit. The `q` key is handled by `tui_input.c` which maps it to `input->button_quit`. Check if there is a `button_quit` field on CELS_Input. If so, use that (the TUI engine likely handles quit from button_quit automatically). If not, check the input mapping. The research says `q` falls through to raw_key. We may need to call a CELS quit function or set a flag. Inspect `cels_input_get` and `CELS_Input` struct for quit handling. If the TUI engine already handles 'q' as quit, we do NOT need manual quit handling -- the engine does it.

Add well-structured comments throughout all files following the style from `examples/app.c` -- section headers, brief doc comments explaining design choices. This is meant to be a reusable template.
  </action>
  <verify>
All four files exist:
- `ls modules/cels-clay/examples/demo/main.c`
- `ls modules/cels-clay/examples/demo/components.h`
- `ls modules/cels-clay/examples/demo/theme.h`
- `ls modules/cels-clay/examples/demo/pages.h`

Files are non-empty and contain expected patterns:
- `grep "CEL_Build" modules/cels-clay/examples/demo/main.c`
- `grep "CEL_Clay_Layout" modules/cels-clay/examples/demo/pages.h`
- `grep "CEL_State" modules/cels-clay/examples/demo/components.h`
- `grep "Clay_Color" modules/cels-clay/examples/demo/theme.h`
  </verify>
  <done>
Four source files created with complete demo app implementation: entry point with module init + input system + state, components with NavState + DemoSettings, theme with two switchable color schemes, pages with layout functions + compositions for sidebar + content + three pages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CMake build target for demo app</name>
  <files>CMakeLists.txt</files>
  <action>
Add a `cels_clay_demo` executable target to the root `CMakeLists.txt` (at `/home/cachy/workspaces/libs/cels/CMakeLists.txt`), placed AFTER the existing `app` target block (after line ~183) and BEFORE the Tools section.

Follow the exact pattern from the existing `app` and `space_invaders` targets:

```cmake
# Clay demo application - CELS + Clay layout + ncurses rendering
add_executable(cels_clay_demo
    modules/cels-clay/examples/demo/main.c
)
target_link_libraries(cels_clay_demo PRIVATE
    cels cels-clay cels-ncurses flecs::flecs_static
)
target_include_directories(cels_clay_demo PRIVATE
    ${CMAKE_SOURCE_DIR}/modules/cels-clay/examples/demo
)
set_target_properties(cels_clay_demo PROPERTIES
    C_STANDARD 99
    C_STANDARD_REQUIRED ON
)
```

Link to: `cels`, `cels-clay`, `cels-ncurses`, `flecs::flecs_static` -- same as app but adding cels-clay.
Include directories: the demo directory itself (for `"components.h"`, `"pages.h"`, `"theme.h"` includes).
  </action>
  <verify>
`grep "cels_clay_demo" CMakeLists.txt` shows the target definition.
`cd /home/cachy/workspaces/libs/cels && cmake --build build --target cels_clay_demo 2>&1` compiles without errors.
  </verify>
  <done>
CMake target `cels_clay_demo` exists, links correct libraries, compiles successfully with C99 standard.
  </done>
</task>

</tasks>

<verification>
1. All four demo source files exist in `modules/cels-clay/examples/demo/`
2. `cmake --build build --target cels_clay_demo` compiles cleanly (zero errors, zero warnings ideally)
3. Key patterns present: CEL_Build, Clay_Engine_use, clay_ncurses_renderer_init, ClaySurface, CEL_Clay_Layout, CEL_Clay_Children, CEL_Clay_Text, CEL_Update, CEL_Watch
4. Input system uses `raw_key` for j/k/h/l (not axis_left)
5. ClaySurface width divided by 2.0f for aspect ratio
6. Scroll input only called when About page is focused
</verification>

<success_criteria>
- The demo app compiles as `cels_clay_demo` target
- Source files follow established CELS + cels-clay patterns
- Three-page structure (Home, Settings, About) with sidebar navigation
- Theme toggle and border toggle in Settings page
- Scroll container in About page
- Clean, well-commented code suitable as a reusable example
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-app-integration/05-01-SUMMARY.md`
</output>
